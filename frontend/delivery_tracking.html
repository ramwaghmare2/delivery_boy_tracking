<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <title>Delivery Boy</title>
    <style>
        #mapContainer {
            width: 100%;
            height: 500px;
        }
        #routeInfo {
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1 class="text-center">Delivery Boy Side Map View</h1>
    <div id="routeInfo" class="routeInfo"></div>
    <div id="mapContainer"></div>

    <script>
        // Initialize the HERE Maps platform
        var platform = new H.service.Platform({
            apikey: 'y24ahK7VnVrMkaDdBKCQVKKsNi2P8zTp3E-IHzmyfrQ' // Replace with your API key
        });
        var defaultLayers = platform.createDefaultLayers();

        // Initialize the map instance
        var map = new H.Map(
            document.getElementById('mapContainer'),
            defaultLayers.vector.normal.map,
            {
                zoom: 14,
                center: { lat: 0, lng: 0 } // Default center, will update with actual location
            }
        );

        // Enable map events
        var mapEvents = new H.mapevents.MapEvents(map);
        var behavior = new H.mapevents.Behavior(mapEvents);
        var ui = H.ui.UI.createDefault(map, defaultLayers);

        // Parse latitude and longitude from Flask template (user location)
        var latitudeStr = "{{ latitude|safe }}";  // User's latitude from Flask
        var longitudeStr = "{{ longitude|safe }}";  // User's longitude from Flask
        var userAddress = "{{ delivery_location|safe }}";  // User's address from Flask

        // Convert the latitude and longitude into floats (user location)
        var userLat = parseFloat(latitudeStr.trim());
        var userLng = parseFloat(longitudeStr.trim());

        // Ensure coordinates are valid numbers
        if (!isNaN(userLat) && !isNaN(userLng)) {
            // Add marker for the user's delivery location
            var userMarker = new H.map.Marker({ lat: userLat, lng: userLng });
            map.addObject(userMarker);
            
            // Add user info bubble
            var userInfoBubble = new H.ui.InfoBubble(userMarker.getGeometry(), { content: userAddress });
            ui.addBubble(userInfoBubble);
        } else {
            console.error("Invalid user latitude or longitude:", userLat, userLng);
        }

        var deliveryBoyMarker;  // Marker for delivery boy's location

        // Function to update delivery boy's position on the map
        function updateDeliveryBoyLocation(coords) {
            if (deliveryBoyMarker) {
                deliveryBoyMarker.setGeometry(coords);  // Update the marker's position
            } else {
                // Add marker for the delivery boy with custom icon if not already set
                var deliveryBoyIcon = new H.map.Icon('https://png.pngtree.com/png-clipart/20200701/original/pngtree-delivery-boy-with-mask-riding-bike-vector-png-image_5354632.jpg', {
                    size: { w: 50, h: 50 },
                    anchor: { x: 25, y: 50 }
                });
                deliveryBoyMarker = new H.map.Marker(coords, { icon: deliveryBoyIcon });
                map.addObject(deliveryBoyMarker);
            }

            // Update map center to follow the delivery boy's location
            map.setCenter(coords);
        }

        // Send coordinates to backend using POST request
        function sendCoordsToBackend(coords) {
            fetch('/update_delivery_location', {  // Flask route for updating location
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    delivery_boy_id:1,
                    latitude: coords.lat,
                    longitude: coords.lng
                })
            }).then(response => {
                if (!response.ok) {
                    throw new Error("Error sending coordinates to the backend");
                }
                return response.json();
            }).then(data => {
                console.log("Location updated on the backend:", data);
            }).catch(error => {
                console.error("Failed to send coordinates:", error);
            });
        }

        // Get the delivery boy's actual location using the Geolocation API
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((position) => {
                var deliveryBoyCoords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Update delivery boy's location on the map
                updateDeliveryBoyLocation(deliveryBoyCoords);

                // Send coordinates to the backend
                sendCoordsToBackend(deliveryBoyCoords);

                // Calculate and display the route between delivery boy and user
                calculateRoutes(deliveryBoyCoords, { lat: userLat, lng: userLng });

            }, (error) => {
                alert("Error fetching location: " + error.message);
                console.error("Geolocation error:", error);
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        // Function to calculate and display multiple routes
        function calculateRoutes(startCoords, endCoords) {
            var router = platform.getRoutingService(null, 8);  // Use version 8 of Routing API

            var routeParams = {
                'routingMode': 'fast',
                'transportMode': 'car',
                'origin': `${startCoords.lat},${startCoords.lng}`,  // Start point (delivery boy)
                'destination': `${endCoords.lat},${endCoords.lng}`,  // Destination point (user)
                'alternatives': 2,  // Request 3 alternative routes
                'return': 'polyline,summary'
            };

            // Call the Routing API
            router.calculateRoute(
                routeParams,
                (result) => {
                    var routeLines = [];
                    if (result.routes.length > 0) {
                        result.routes.forEach((route, index) => {
                            var routeShape = route.sections[0].polyline;
                            var lineString = H.geo.LineString.fromFlexiblePolyline(routeShape);
                            var routeLine = new H.map.Polyline(lineString, {
                                style: { strokeColor: index === 0 ? 'blue' : 'gray', lineWidth: 5 }
                            });
                            map.addObject(routeLine);
                            routeLines.push(routeLine);

                            // Event listener to select a route
                            routeLine.addEventListener('tap', () => {
                                routeLine.setStyle({ strokeColor: 'blue', lineWidth: 7 });
                                var distance = route.sections[0].summary.length / 1000;
                                var travelTime = route.sections[0].summary.duration / 60;
                                document.getElementById('routeInfo').innerHTML = `Selected Route - Distance: ${distance.toFixed(2)} km | Travel Time: ${Math.round(travelTime)} minutes`;
                            });
                        });

                        map.getViewModel().setLookAtData({ bounds: routeLines[0].getBoundingBox() });
                    } else {
                        console.error('No routes found');
                    }
                },
                (error) => {
                    alert('Error calculating route: ' + error.message);
                    console.error('Error details:', error);
                }
            );
        }
    </script>
</body>
</html>
